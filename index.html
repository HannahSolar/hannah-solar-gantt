<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah Solar â€” Project Gantt</title>

  <!-- DHTMLX Gantt (GPL) -->
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css"/>
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js" type="text/javascript"></script>

  <style>
    /* â”€â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:          #0d1117;
      --surface:     #161b22;
      --surface2:    #1c2330;
      --border:      #30363d;
      --accent:      #f0a500;
      --accent2:     #e8c44a;
      --green:       #3fb950;
      --blue:        #58a6ff;
      --red:         #f85149;
      --muted:       #8b949e;
      --text:        #e6edf3;
      --text-dim:    #c9d1d9;
      --font-ui:     'DM Sans', sans-serif;
      --font-mono:   'JetBrains Mono', monospace;
      --radius:      6px;
      --header-h:    56px;
      --toolbar-h:   44px;
    }

    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 13px;
      overflow: hidden;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      position: relative;
      z-index: 100;
    }

    #header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #header .logo svg {
      width: 28px; height: 28px;
    }

    #header .logo-text {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    #header .logo-text span {
      color: var(--accent);
    }

    #header .divider {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    #header .page-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    #header .spacer { flex: 1; }

    #header .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
    }

    #header .status-pill .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--muted);
      transition: background 0.3s;
    }

    #header .status-pill.connected .dot  { background: var(--green); }
    #header .status-pill.connected       { color: var(--green); border-color: rgba(63,185,80,0.3); }
    #header .status-pill.error .dot      { background: var(--red); }
    #header .status-pill.error           { color: var(--red); border-color: rgba(248,81,73,0.3); }
    #header .status-pill.loading .dot    { background: var(--accent); animation: pulse 1s infinite; }
    #header .status-pill.loading         { color: var(--accent); border-color: rgba(240,165,0,0.3); }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* â”€â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toolbar {
      height: var(--toolbar-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 8px;
      z-index: 99;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text-dim);
      font-family: var(--font-ui);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--border); color: var(--text); }
    .btn.active {
      background: rgba(240,165,0,0.15);
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #000;
      font-weight: 600;
    }
    .btn.primary:hover { background: var(--accent2); }

    .btn-group {
      display: flex;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .btn-group .btn {
      border: none;
      border-radius: 0;
      border-right: 1px solid var(--border);
    }
    .btn-group .btn:last-child { border-right: none; }

    .tb-sep {
      width: 1px;
      height: 20px;
      background: var(--border);
      margin: 0 4px;
    }

    .tb-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 2px;
    }

    #project-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 12px;
      padding: 5px 10px;
      border-radius: var(--radius);
      cursor: pointer;
      min-width: 180px;
    }
    #project-select:focus { outline: none; border-color: var(--accent); }

    /* â”€â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #legend {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-left: auto;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--muted);
    }
    .legend-dot {
      width: 10px; height: 10px;
      border-radius: 2px;
    }
    .legend-diamond {
      width: 8px; height: 8px;
      background: var(--accent);
      transform: rotate(45deg);
    }

    /* â”€â”€â”€ GANTT WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #gantt-wrap {
      position: absolute;
      top: calc(var(--header-h) + var(--toolbar-h));
      left: 0; right: 0; bottom: 0;
    }

    #gantt_here {
      width: 100%;
      height: 100%;
    }

    /* â”€â”€â”€ OVERLAY (loading / error) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(13,17,23,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      z-index: 200;
      backdrop-filter: blur(4px);
    }
    #overlay.hidden { display: none; }

    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .overlay-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .overlay-sub {
      font-size: 12px;
      color: var(--muted);
      max-width: 320px;
      text-align: center;
      line-height: 1.6;
    }
    .overlay-error { color: var(--red); }

    /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 500;
      z-index: 9999;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.success { background: rgba(63,185,80,0.15); border: 1px solid var(--green); color: var(--green); }
    #toast.error   { background: rgba(248,81,73,0.15);  border: 1px solid var(--red);   color: var(--red); }
    #toast.info    { background: rgba(240,165,0,0.15);  border: 1px solid var(--accent); color: var(--accent); }
    #toast.hidden  { opacity: 0; }

    /* â”€â”€â”€ DHTMLX GANTT OVERRIDES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gantt_container,
    .gantt_task,
    .gantt_grid,
    .gantt_grid_scale,
    .gantt_task_scale,
    .gantt_task_bg {
      background: var(--bg) !important;
      color: var(--text) !important;
    }

    .gantt_grid_head_cell,
    .gantt_scale_cell,
    .gantt_scale_line {
      background: var(--surface) !important;
      color: var(--muted) !important;
      border-color: var(--border) !important;
      font-family: var(--font-ui) !important;
      font-size: 11px !important;
      font-weight: 500 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.4px !important;
    }

    .gantt_row,
    .gantt_task_row {
      border-color: var(--border) !important;
    }

    .gantt_row:hover,
    .gantt_task_row:hover {
      background: var(--surface2) !important;
    }

    .gantt_row.odd,
    .gantt_task_row.odd {
      background: rgba(22,27,34,0.5) !important;
    }

    .gantt_cell {
      color: var(--text-dim) !important;
      border-color: var(--border) !important;
      font-family: var(--font-ui) !important;
      font-size: 12px !important;
    }

    .gantt_grid_scale,
    .gantt_task_scale {
      border-bottom: 1px solid var(--border) !important;
    }

    /* Task bars */
    .gantt_task_line {
      border-radius: 3px !important;
      border: none !important;
    }

    .gantt_task_line.status-complete     { background: var(--green) !important; }
    .gantt_task_line.status-in-progress  { background: var(--blue)  !important; }
    .gantt_task_line.status-delayed      { background: var(--red)   !important; }
    .gantt_task_line.status-not-started  { background: #3d444d !important; }
    .gantt_task_line.type-project        { background: rgba(240,165,0,0.25) !important; border: 1px solid var(--accent) !important; border-radius: 2px !important; }
    .gantt_task_line.type-milestone-bar  {
      background: transparent !important;
    }

    /* Milestone diamonds */
    .gantt_task_line.gantt_milestone {
      background: var(--accent) !important;
    }
    .gantt_task_line.gantt_milestone .gantt_task_content {
      color: #000 !important;
      font-weight: 600 !important;
      font-size: 10px !important;
    }

    /* Progress bar */
    .gantt_task_progress {
      border-radius: 3px !important;
      opacity: 0.35 !important;
      background: #fff !important;
    }

    /* Links */
    .gantt_task_link .gantt_line_wrapper div { background: var(--border) !important; }
    .gantt_link_arrow { border-color: var(--border) !important; }

    /* Today line */
    .gantt_task_line.gantt_today { background: rgba(240,165,0,0.08) !important; }
    .gantt_marker { background: var(--accent) !important; opacity: 0.6; }
    .gantt_marker_content { color: #000; font-size: 10px; font-weight: 700; padding: 2px 4px; }

    /* Scrollbars */
    .gantt_ver_scroll, .gantt_hor_scroll { background: var(--surface) !important; }

    /* Tooltip */
    .gantt_tooltip {
      background: var(--surface2) !important;
      border: 1px solid var(--border) !important;
      color: var(--text) !important;
      font-family: var(--font-ui) !important;
      font-size: 12px !important;
      border-radius: var(--radius) !important;
      padding: 10px 14px !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4) !important;
    }

    /* Grid column headers */
    .gantt_grid_head_cell { text-align: left !important; padding-left: 8px !important; }

    /* Drag handle */
    .gantt_task_drag { opacity: 0; }
    .gantt_task_line:hover .gantt_task_drag { opacity: 1; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="header">
  <div class="logo">
    <!-- Sun icon -->
    <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="14" cy="14" r="5.5" fill="#f0a500"/>
      <line x1="14" y1="2"  x2="14" y2="5.5"  stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="22.5" x2="14" y2="26" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="2"  y1="14" x2="5.5"  y2="14" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="22.5" y1="14" x2="26" y2="14" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="5.5"  y1="5.5"  x2="8"  y2="8"  stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="20"   y1="20"   x2="22.5" y2="22.5" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="22.5" y1="5.5"  x2="20"   y2="8"    stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
      <line x1="8"    y1="20"   x2="5.5"  y2="22.5" stroke="#f0a500" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="logo-text">Hannah <span>Solar</span></span>
  </div>
  <div class="divider"></div>
  <div class="page-title">Project Gantt</div>
  <div class="spacer"></div>
  <div id="status-pill" class="status-pill loading">
    <div class="dot"></div>
    <span id="status-text">Connectingâ€¦</span>
  </div>
</div>

<!-- â”€â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toolbar">
  <span class="tb-label">View</span>
  <div class="btn-group">
    <button class="btn active" id="btn-all" onclick="setView('all')">All Projects</button>
    <button class="btn" id="btn-project" onclick="setView('project')">Per Project</button>
  </div>

  <div class="tb-sep"></div>

  <span class="tb-label">Zoom</span>
  <div class="btn-group">
    <button class="btn" id="zoom-month"   onclick="setZoom('month')">Month</button>
    <button class="btn active" id="zoom-quarter" onclick="setZoom('quarter')">Quarter</button>
    <button class="btn" id="zoom-year"    onclick="setZoom('year')">Year</button>
  </div>

  <div class="tb-sep"></div>

  <span class="tb-label">Project</span>
  <select id="project-select" onchange="filterProject(this.value)">
    <option value="all">â€” All Projects â€”</option>
  </select>

  <div class="tb-sep"></div>

  <button class="btn primary" onclick="refreshData()">â†» Refresh</button>

  <!-- Legend -->
  <div id="legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Complete</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>In Progress</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>Delayed</div>
    <div class="legend-item"><div class="legend-dot" style="background:#3d444d"></div>Not Started</div>
    <div class="legend-item"><div class="legend-diamond"></div>Milestone</div>
  </div>
</div>

<!-- â”€â”€â”€ GANTT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="gantt-wrap">
  <div id="gantt_here"></div>

  <!-- Loading/Error overlay -->
  <div id="overlay">
    <div class="spinner"></div>
    <div class="overlay-title">Loading Projectsâ€¦</div>
    <div class="overlay-sub" id="overlay-sub">Connecting to Zoho Creator</div>
  </div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast" class="hidden"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURATION â€” Update these values
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CONFIG = {
  clientId:     '1000.BLOH3Q6D2RLURL3X7I8MBOLOSZKJ9A',
  clientSecret: '3448d7ff6a2f41fb5721b6afa63f918ab6e66edacc',
  refreshToken: '1000.20d461521b84917fa16da7d8498e06dc.e66f51e1fc859d0e808d73f8cd60d279',
  accountsUrl:  'https://accounts.zoho.com',
  apiDomain:    'https://www.zohoapis.com',
  ownerName:    'hannahsolar',
  appLinkName:  'hannah-solar-project-management',
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let accessToken  = null;
let tokenExpiry  = 0;
let allProjects  = [];
let allMilestones = [];
let allTasks     = [];
let currentView  = 'all';
let currentZoom  = 'quarter';
let currentFilter = 'all';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OAUTH â€” Token refresh
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function getAccessToken() {
  if (accessToken) return accessToken;

  // Read token.json generated hourly by GitHub Action â€” no CORS issues
  const resp = await fetch('./token.json?nocache=' + Date.now());
  if (!resp.ok) throw new Error(`Could not load token.json (HTTP ${resp.status})`);
  const data = await resp.json();
  if (!data.access_token) throw new Error('No access_token found in token.json');

  accessToken = data.access_token;
  return accessToken;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CREATOR REST API â€” Fetch records
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchReport(reportLinkName) {
  const token = await getAccessToken();
  const url = `${CONFIG.apiDomain}/creator/v2.1/data/${CONFIG.ownerName}/${CONFIG.appLinkName}/report/${reportLinkName}?max_records=200`;

  const resp = await fetch(url, {
    headers: {
      'Authorization': `Zoho-oauthtoken ${token}`,
    }
  });

  if (!resp.ok) {
    const errText = await resp.text();
    throw new Error(`API error ${resp.status} on ${reportLinkName}: ${errText}`);
  }
  const data = await resp.json();
  return data.data || [];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CREATOR REST API â€” Update a record
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function updateRecord(reportLinkName, recordId, fields) {
  const token = await getAccessToken();
  const url = `${CONFIG.apiDomain}/creator/v2.1/data/${CONFIG.ownerName}/${CONFIG.appLinkName}/report/${reportLinkName}/${recordId}`;

  const resp = await fetch(url, {
    method: 'PATCH',
    headers: {
      'Authorization': `Zoho-oauthtoken ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ data: fields }),
  });

  if (!resp.ok) {
    const errText = await resp.text();
    throw new Error(`Update error ${resp.status}: ${errText}`);
  }
  return await resp.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATE HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseDate(str) {
  if (!str) return null;
  // Creator returns dates in various formats, handle them all
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function formatForCreator(date) {
  if (!date) return null;
  const d = new Date(date);
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = months[d.getMonth()];
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function safeDate(str) {
  const d = parseDate(str);
  return d || new Date();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  setStatus('loading', 'Loadingâ€¦');
  showOverlay('Loading Projectsâ€¦', 'Reading data from Zoho Creator');

  try {
    const resp = await fetch('./data.json?nocache=' + Date.now());
    if (!resp.ok) throw new Error(`Could not load data.json (HTTP ${resp.status}). Run the GitHub Action first.`);
    const data = await resp.json();

    allProjects   = data.projects   || [];
    allMilestones = data.milestones || [];
    allTasks      = data.tasks      || [];

    const updatedAt = data.updated_at ? new Date(data.updated_at).toLocaleTimeString() : 'unknown';

    populateProjectFilter();
    renderGantt();
    hideOverlay();
    setStatus('connected', `${allProjects.length} projects Â· synced ${updatedAt}`);
    showToast(`Loaded ${allProjects.length} projects, ${allMilestones.length} milestones, ${allTasks.length} tasks`, 'success');

  } catch (err) {
    console.error(err);
    showOverlayError(err.message);
    setStatus('error', 'Load failed');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECT FILTER DROPDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function populateProjectFilter() {
  const sel = document.getElementById('project-select');
  // Clear existing options except the "All" option
  while (sel.options.length > 1) sel.remove(1);
  allProjects.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.Project_Name;
    opt.textContent = p.Project_Name;
    sel.appendChild(opt);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD GANTT DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildGanttData() {
  const tasks_data = [];
  const links_data = [];
  let id = 1;

  const filteredProjects = currentFilter === 'all'
    ? allProjects
    : allProjects.filter(p => p.Project_Name === currentFilter);

  filteredProjects.forEach(project => {
    const pStart = safeDate(project.Start_Date);
    const pEnd   = safeDate(project.Projected_End_Date || project.Original_End_Date);
    const pId    = id++;

    // Project row
    tasks_data.push({
      id:        pId,
      text:      project.Project_Name,
      start_date: pStart,
      end_date:   pEnd,
      type:       'project',
      open:       true,
      readonly:   true,
      $source_id: project.ID,
      $type:      'project',
      $status:    project.Project_Status,
    });

    if (currentView === 'all') {
      // All Projects view: milestones only under each project
      const projMilestones = allMilestones.filter(m =>
        m.Project && (m.Project.display_value === project.Project_Name || m.Project === project.Project_Name)
      );

      projMilestones.forEach(m => {
        const mId = id++;
        const mDate = safeDate(m.Planned_End_Date || m.Planned_Start_Date);

        tasks_data.push({
          id:          mId,
          text:        m.Milestone_Name,
          start_date:  mDate,
          end_date:    new Date(mDate.getTime() + 86400000), // 1 day
          type:        'milestone',
          parent:      pId,
          $source_id:  m.ID,
          $type:       'milestone',
          $status:     m.Status,
          $payment:    m.Payment_Triggered,
          $amount:     m.Payment_Amount,
        });
      });

    } else {
      // Per Project view: phases â†’ milestones â†’ tasks
      const projMilestones = allMilestones.filter(m =>
        m.Project && (m.Project.display_value === project.Project_Name || m.Project === project.Project_Name)
      );

      // Group milestones by phase
      const phases = {};
      projMilestones.forEach(m => {
        const ph = m.Phase || 'General';
        if (!phases[ph]) phases[ph] = [];
        phases[ph].push(m);
      });

      Object.entries(phases).forEach(([phase, phaseMilestones]) => {
        // Phase group row
        const phaseId = id++;
        const phaseDates = phaseMilestones
          .map(m => safeDate(m.Planned_Start_Date))
          .filter(Boolean);
        const phaseEndDates = phaseMilestones
          .map(m => safeDate(m.Planned_End_Date))
          .filter(Boolean);

        const phaseStart = phaseDates.length   ? new Date(Math.min(...phaseDates))    : pStart;
        const phaseEnd   = phaseEndDates.length ? new Date(Math.max(...phaseEndDates)) : pEnd;

        tasks_data.push({
          id:         phaseId,
          text:       phase,
          start_date: phaseStart,
          end_date:   phaseEnd,
          type:       'project',
          parent:     pId,
          open:       true,
          readonly:   true,
          $type:      'phase',
        });

        phaseMilestones.forEach(m => {
          const mId    = id++;
          const mStart = safeDate(m.Planned_Start_Date);
          const mEnd   = safeDate(m.Planned_End_Date);

          tasks_data.push({
            id:         mId,
            text:       m.Milestone_Name,
            start_date: mStart,
            end_date:   mEnd,
            type:       gantt.config.types.task,
            parent:     phaseId,
            open:       true,
            $source_id: m.ID,
            $type:      'milestone',
            $status:    m.Status,
            $payment:   m.Payment_Triggered,
            $amount:    m.Payment_Amount,
          });

          // Tasks under this milestone
          const milestoneTasks = allTasks.filter(t =>
            t.Milestone && (t.Milestone.display_value === m.Milestone_Name || t.Milestone === m.Milestone_Name)
          );

          milestoneTasks.forEach(t => {
            const tId = id++;
            tasks_data.push({
              id:         tId,
              text:       t.Task_Name,
              start_date: safeDate(t.Planned_Start_Date),
              end_date:   safeDate(t.Planned_End_Date),
              type:       gantt.config.types.task,
              parent:     mId,
              $source_id: t.ID,
              $type:      'task',
              $status:    t.Status,
              $form:      'All_Tasks',
            });
          });
        });
      });
    }
  });

  return { data: tasks_data, links: links_data };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GANTT INIT & CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initGantt() {
  gantt.config.date_format   = '%Y-%m-%d';
  gantt.config.xml_date      = '%Y-%m-%d';
  gantt.config.scroll_on_click = false;
  gantt.config.show_progress = true;
  gantt.config.readonly      = false;
  gantt.config.drag_progress = false;
  gantt.config.drag_links    = false;
  gantt.config.drag_move     = true;
  gantt.config.drag_resize   = true;
  gantt.config.open_tree_initially = true;
  gantt.config.fit_tasks     = true;
  gantt.config.row_height    = 34;
  gantt.config.bar_height    = 20;
  gantt.config.min_column_width = 40;
  gantt.config.autosize      = false;

  // Grid columns
  gantt.config.columns = [
    {
      name:  'text',
      label: 'Task / Milestone',
      width: 240,
      tree:  true,
      template: (task) => {
        const icon = task.$type === 'milestone' ? 'â—† ' :
                     task.$type === 'phase'     ? 'â–¸ ' :
                     task.$type === 'project'   ? '' : '  ';
        return icon + (task.text || '');
      }
    },
    {
      name:  'start_date',
      label: 'Start',
      width: 90,
      align: 'center',
      template: (task) => {
        if (!task.start_date) return 'â€”';
        return task.start_date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    },
    {
      name:  'end_date',
      label: 'End',
      width: 90,
      align: 'center',
      template: (task) => {
        if (!task.end_date || task.type === 'milestone') return 'â€”';
        return task.end_date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    },
    {
      name:  '$status',
      label: 'Status',
      width: 100,
      align: 'center',
      template: (task) => {
        if (!task.$status) return '';
        const colors = {
          'Complete':     '#3fb950',
          'In Progress':  '#58a6ff',
          'Delayed':      '#f85149',
          'Not Started':  '#8b949e',
          'Blocked':      '#f85149',
          'In Progress':  '#58a6ff',
        };
        const c = colors[task.$status] || '#8b949e';
        return `<span style="color:${c};font-size:11px;font-weight:500;">${task.$status}</span>`;
      }
    },
  ];

  // Zoom: Quarter (default)
  setZoom('quarter', false);

  // Task class by status
  gantt.templates.task_class = (start, end, task) => {
    const classes = [];
    if (task.type === 'project') classes.push('type-project');
    if (task.$status === 'Complete')    classes.push('status-complete');
    if (task.$status === 'In Progress') classes.push('status-in-progress');
    if (task.$status === 'Delayed')     classes.push('status-delayed');
    if (task.$status === 'Not Started') classes.push('status-not-started');
    if (task.$type === 'milestone')     classes.push('type-milestone-bar');
    return classes.join(' ');
  };

  // Tooltip
  gantt.templates.tooltip_text = (start, end, task) => {
    let html = `<strong style="color:var(--text)">${task.text}</strong><br/>`;
    if (task.$status) html += `<span style="color:var(--muted)">Status:</span> ${task.$status}<br/>`;
    if (task.start_date) html += `<span style="color:var(--muted)">Start:</span> ${task.start_date.toLocaleDateString()}<br/>`;
    if (task.end_date && task.type !== 'milestone') html += `<span style="color:var(--muted)">End:</span> ${task.end_date.toLocaleDateString()}<br/>`;
    if (task.$payment === 'Yes' && task.$amount) html += `<span style="color:var(--accent)">ğŸ’° Payment: $${Number(task.$amount).toLocaleString()}</span>`;
    return html;
  };

  // Grid row class
  gantt.templates.grid_row_class = (start, end, task) => {
    if (task.type === 'project' && task.$type !== 'phase') return 'gantt_project_row';
    return '';
  };

  // Today marker (only if supported in this build)
  if (typeof gantt.addMarker === 'function') {
    gantt.addMarker({
      start_date: new Date(),
      css: 'gantt_today',
      text: 'Today',
      title: 'Today'
    });
  }

  // â”€â”€ DRAG HANDLER â€” write back to Creator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  gantt.attachEvent('onAfterTaskDrag', async (id, mode, e) => {
    const task = gantt.getTask(id);

    // Skip project/phase rows â€” they're readonly
    if (task.type === 'project' || task.$type === 'phase') {
      gantt.refreshTask(id);
      return;
    }

    if (!task.$source_id) return;

    const newStart = formatForCreator(task.start_date);
    const newEnd   = formatForCreator(task.end_date);
    const report   = task.$form || (task.$type === 'task' ? 'All_Tasks' : 'All_Milestones');

    showToast('Saving schedule changeâ€¦', 'info');

    try {
      await updateRecord(report, task.$source_id, {
        Planned_Start_Date: newStart,
        Planned_End_Date:   newEnd,
      });

      showToast(`Updated: ${task.text}`, 'success');
    } catch (err) {
      console.error('Update failed:', err);
      showToast(`Save failed: ${err.message}`, 'error');
      // Revert visual
      gantt.refreshTask(id);
    }
  });

  gantt.init('gantt_here');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER GANTT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGantt() {
  const { data, links } = buildGanttData();

  if (data.length === 0) {
    showOverlayError('No project data found. Add projects in Zoho Creator first.');
    return;
  }

  gantt.clearAll();
  gantt.parse({ data, links });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZOOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setZoom(level, rerender = true) {
  currentZoom = level;

  // Update button states
  ['month','quarter','year'].forEach(z => {
    document.getElementById(`zoom-${z}`).classList.toggle('active', z === level);
  });

  if (level === 'month') {
    gantt.config.scales = [
      { unit: 'month', step: 1, format: '%F %Y' },
      { unit: 'week',  step: 1, format: 'Wk %W' },
    ];
    gantt.config.min_column_width = 80;
  } else if (level === 'quarter') {
    gantt.config.scales = [
      { unit: 'quarter', step: 1, format: (d) => {
          const q = Math.floor(d.getMonth() / 3) + 1;
          return `Q${q} ${d.getFullYear()}`;
        }
      },
      { unit: 'month', step: 1, format: '%M' },
    ];
    gantt.config.min_column_width = 60;
  } else {
    gantt.config.scales = [
      { unit: 'year',    step: 1, format: '%Y' },
      { unit: 'quarter', step: 1, format: (d) => {
          return `Q${Math.floor(d.getMonth()/3)+1}`;
        }
      },
    ];
    gantt.config.min_column_width = 80;
  }

  if (rerender && allProjects.length > 0) {
    gantt.render();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setView(view) {
  currentView = view;
  document.getElementById('btn-all').classList.toggle('active', view === 'all');
  document.getElementById('btn-project').classList.toggle('active', view === 'project');
  if (allProjects.length > 0) renderGantt();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECT FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function filterProject(value) {
  currentFilter = value;
  if (allProjects.length > 0) renderGantt();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshData() {
  accessToken = null; // Force token refresh
  loadData();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setStatus(state, text) {
  const pill = document.getElementById('status-pill');
  const span = document.getElementById('status-text');
  pill.className = `status-pill ${state}`;
  span.textContent = text;
}

function showOverlay(title, sub) {
  const el = document.getElementById('overlay');
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="spinner"></div>
    <div class="overlay-title">${title}</div>
    <div class="overlay-sub">${sub}</div>
  `;
}

function showOverlayError(msg) {
  const el = document.getElementById('overlay');
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="overlay-title overlay-error">âš  Connection Error</div>
    <div class="overlay-sub">${msg}</div>
    <button class="btn primary" style="margin-top:8px" onclick="refreshData()">Retry</button>
  `;
}

function hideOverlay() {
  document.getElementById('overlay').classList.add('hidden');
}

let toastTimer = null;
function showToast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.className = `${type}`;
  el.textContent = msg;
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = 'hidden'; }, 3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT â€” wait for all scripts to load
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('load', () => {
  if (typeof gantt === 'undefined') {
    showOverlayError('Gantt library failed to load. Please check your internet connection and refresh.');
    setStatus('error', 'Library failed');
    return;
  }
  initGantt();
  loadData();
});
</script>
</body>
</html>
