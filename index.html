<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hannah Solar â€” Project Gantt</title>

  <!-- DHTMLX Gantt (GPL) -->
  <link rel="stylesheet" href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css"/>
  <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js" type="text/javascript"></script>

  <style>
    /* â”€â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:          #FFFFFF;
      --surface:     #F8F9FA;
      --surface2:    #F1F3F5;
      --border:      #E5E7EB;
      --accent:      #D84315;
      --accent2:     #BF360C;
      --green:       #2E7D32;
      --blue:        #1565C0;
      --red:         #C62828;
      --muted:       #6B7280;
      --text:        #1F2937;
      --text-dim:    #374151;
      --font-ui:     'Inter', sans-serif;
      --font-mono:   'DM Mono', monospace;
      --radius:      6px;
      --header-h:    52px;
      --toolbar-h:   44px;
    }

    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 13px;
      overflow: hidden;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #header {
      height: var(--header-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 16px;
      position: relative;
      z-index: 100;
    }

    #header .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #header .logo svg {
      width: 26px; height: 26px;
    }

    #header .logo-text {
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.3px;
    }

    #header .logo-text span {
      color: var(--accent);
    }

    #header .divider {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    #header .page-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.4px;
      text-transform: uppercase;
    }

    #header .spacer { flex: 1; }

    #header .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
    }

    #header .status-pill .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--muted);
      transition: background 0.3s;
    }

    #header .status-pill.connected .dot  { background: var(--green); }
    #header .status-pill.connected       { color: var(--green); border-color: rgba(46,125,50,0.3); }
    #header .status-pill.error .dot      { background: var(--red); }
    #header .status-pill.error           { color: var(--red); border-color: rgba(198,40,40,0.3); }
    #header .status-pill.loading .dot    { background: var(--accent); animation: pulse 1s infinite; }
    #header .status-pill.loading         { color: var(--accent); border-color: rgba(216,67,21,0.3); }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

    /* â”€â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toolbar {
      height: var(--toolbar-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 8px;
      z-index: 99;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-dim);
      font-family: var(--font-ui);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn:hover { background: var(--surface2); color: var(--text); }
    .btn.active {
      background: rgba(216,67,21,0.08);
      border-color: var(--accent);
      color: var(--accent);
    }
    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      font-weight: 600;
    }
    .btn.primary:hover { background: var(--accent2); border-color: var(--accent2); }

    .btn-group {
      display: flex;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }
    .btn-group .btn {
      border: none;
      border-radius: 0;
      border-right: 1px solid var(--border);
    }
    .btn-group .btn:last-child { border-right: none; }

    .tb-sep {
      width: 1px;
      height: 20px;
      background: var(--border);
      margin: 0 4px;
    }

    .tb-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-right: 2px;
    }

    #project-select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-ui);
      font-size: 12px;
      padding: 5px 10px;
      border-radius: var(--radius);
      cursor: pointer;
      min-width: 180px;
    }
    #project-select:focus { outline: none; border-color: var(--accent); }

    /* â”€â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #legend {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-left: auto;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--muted);
    }
    .legend-dot {
      width: 10px; height: 10px;
      border-radius: 2px;
    }
    .legend-diamond {
      width: 8px; height: 8px;
      background: var(--accent);
      transform: rotate(45deg);
    }

    /* â”€â”€â”€ GANTT WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #gantt-wrap {
      position: absolute;
      top: calc(var(--header-h) + var(--toolbar-h));
      left: 0; right: 0; bottom: 0;
    }

    #gantt_here {
      width: 100%;
      height: 100%;
    }

    /* â”€â”€â”€ OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      z-index: 200;
      backdrop-filter: blur(4px);
    }
    #overlay.hidden { display: none; }

    .spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .overlay-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .overlay-sub {
      font-size: 12px;
      color: var(--muted);
      max-width: 320px;
      text-align: center;
      line-height: 1.6;
    }
    .overlay-error { color: var(--red); }

    /* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 16px;
      border-radius: var(--radius);
      font-size: 12px;
      font-weight: 500;
      z-index: 9999;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    #toast.success { background: rgba(46,125,50,0.1);   border: 1px solid var(--green); color: var(--green); }
    #toast.error   { background: rgba(198,40,40,0.1);   border: 1px solid var(--red);   color: var(--red); }
    #toast.info    { background: rgba(216,67,21,0.08);  border: 1px solid var(--accent); color: var(--accent); }
    #toast.hidden  { opacity: 0; }

    /* â”€â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #detail-modal {
      position: fixed;
      inset: 0;
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.3);
      backdrop-filter: blur(3px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    #detail-modal.open {
      opacity: 1;
      pointer-events: all;
    }
    #detail-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 420px;
      max-width: 90vw;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    #detail-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: var(--surface);
    }
    #detail-header .detail-title {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      line-height: 1.4;
    }
    #detail-header .detail-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
    }
    #detail-header .detail-close:hover { color: var(--text); }
    #detail-body {
      padding: 16px 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .detail-field { display: flex; flex-direction: column; gap: 3px; }
    .detail-field.full { grid-column: 1 / -1; }
    .detail-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .detail-value { font-size: 13px; color: var(--text-dim); }
    .detail-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
      font-weight: 500;
    }
    .detail-status .dot { width: 7px; height: 7px; border-radius: 50%; }
    #detail-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      background: var(--surface);
    }

    /* â”€â”€â”€ PRINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media print {
      #header, #toolbar, #overlay, #toast, #detail-modal { display: none !important; }
      #gantt-wrap { position: static !important; width: 100% !important; height: auto !important; }
      #gantt_here { width: 100% !important; height: 800px !important; }
    }

    /* â”€â”€â”€ DHTMLX GANTT OVERRIDES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .gantt_container,
    .gantt_task,
    .gantt_grid,
    .gantt_grid_scale,
    .gantt_task_scale,
    .gantt_task_bg {
      background: var(--bg) !important;
      color: var(--text) !important;
    }

    .gantt_grid_head_cell,
    .gantt_scale_cell,
    .gantt_scale_line {
      background: var(--surface) !important;
      color: var(--muted) !important;
      border-color: var(--border) !important;
      font-family: var(--font-ui) !important;
      font-size: 11px !important;
      font-weight: 600 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.4px !important;
    }

    .gantt_row, .gantt_task_row { border-color: var(--border) !important; }
    .gantt_row:hover, .gantt_task_row:hover { background: #FFF8F6 !important; }
    .gantt_row.odd, .gantt_task_row.odd { background: var(--surface) !important; }
    .gantt_row, .gantt_task_row { background: var(--bg) !important; }

    .gantt_cell {
      color: var(--text-dim) !important;
      border-color: var(--border) !important;
      font-family: var(--font-ui) !important;
      font-size: 12px !important;
    }

    .gantt_grid_scale, .gantt_task_scale { border-bottom: 1px solid var(--border) !important; }

    /* Task bars */
    .gantt_task_line { border-radius: 3px !important; border: none !important; }
    .gantt_task_line.status-complete     { background: #2E7D32 !important; }
    .gantt_task_line.status-in-progress  { background: #1565C0 !important; }
    .gantt_task_line.status-delayed      { background: #C62828 !important; }
    .gantt_task_line.status-not-started  { background: #9CA3AF !important; }

    /* Project / phase summary bars */
    .gantt_task_line.type-project {
      background: rgba(216,67,21,0.12) !important;
      border: 1px solid rgba(216,67,21,0.4) !important;
      border-radius: 2px !important;
    }

    /* Milestone bars */
    .gantt_task_line.type-milestone-bar {
      background: #9CA3AF !important;
      height: 10px !important;
      margin-top: 5px !important;
      border-radius: 2px !important;
    }
    .gantt_task_line.type-milestone-bar.status-complete    { background: #2E7D32 !important; }
    .gantt_task_line.type-milestone-bar.status-in-progress { background: #1565C0 !important; }
    .gantt_task_line.type-milestone-bar.status-delayed     { background: #C62828 !important; }
    .gantt_task_line.type-milestone-bar.status-not-started { background: #9CA3AF !important; }
    .gantt_task_line.type-milestone-bar .gantt_task_content { font-size: 10px !important; line-height: 10px !important; }

    /* DHTMLX milestone diamonds */
    .gantt_task_line.gantt_milestone { background: var(--accent) !important; border-color: var(--accent) !important; }
    .gantt_task_line.gantt_milestone .gantt_task_content { color: #fff !important; font-weight: 700 !important; font-size: 10px !important; }

    /* Task bar text */
    .gantt_task_content {
      color: rgba(255,255,255,0.95) !important;
      font-size: 11px !important;
      font-weight: 500 !important;
      font-family: var(--font-ui) !important;
    }
    .gantt_task_line.type-project .gantt_task_content { color: var(--accent) !important; font-weight: 600 !important; }

    /* Progress bar */
    .gantt_task_progress { border-radius: 3px !important; opacity: 0.2 !important; background: #fff !important; }

    /* Links */
    .gantt_task_link .gantt_line_wrapper div { background: var(--border) !important; }
    .gantt_link_arrow { border-color: var(--border) !important; }

    /* Today marker */
    .gantt_task_line.gantt_today { background: rgba(216,67,21,0.05) !important; }
    .gantt_marker { background: var(--accent) !important; opacity: 0.5; }
    .gantt_marker_content { color: #fff; font-size: 10px; font-weight: 700; padding: 2px 4px; }

    /* Scrollbars */
    .gantt_ver_scroll, .gantt_hor_scroll { background: var(--surface) !important; }
    .gantt_scroll_content { background: var(--border) !important; border-radius: 4px !important; }
    .gantt_layout_cell_border { border-color: var(--border) !important; }

    .gantt_task::-webkit-scrollbar { height: 10px; width: 10px; }
    .gantt_task::-webkit-scrollbar-track { background: var(--surface); }
    .gantt_task::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .gantt_task::-webkit-scrollbar-thumb:hover { background: var(--muted); }
    .gantt_grid_data::-webkit-scrollbar { width: 10px; }
    .gantt_grid_data::-webkit-scrollbar-track { background: var(--surface); }
    .gantt_grid_data::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* Tooltip */
    .gantt_tooltip {
      background: var(--bg) !important;
      border: 1px solid var(--border) !important;
      color: var(--text) !important;
      font-family: var(--font-ui) !important;
      font-size: 12px !important;
      border-radius: var(--radius) !important;
      padding: 10px 14px !important;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1) !important;
    }

    .gantt_grid_head_cell { text-align: left !important; padding-left: 8px !important; }
    .gantt_tree_content { font-family: var(--font-ui) !important; }

    .gantt_row.gantt_project_row .gantt_cell {
      color: var(--accent) !important;
      font-weight: 600 !important;
    }

    .gantt_task_drag { opacity: 0; }
    .gantt_task_line:hover .gantt_task_drag { opacity: 1; }
    .gantt_task_line, .gantt_task_line * { box-shadow: none !important; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="header">
  <div class="logo">
    <svg viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="14" cy="14" r="5.5" fill="#D84315"/>
      <line x1="14" y1="2"  x2="14" y2="5.5"  stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="14" y1="22.5" x2="14" y2="26" stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="2"  y1="14" x2="5.5"  y2="14" stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="22.5" y1="14" x2="26" y2="14" stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="5.5"  y1="5.5"  x2="8"  y2="8"  stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="20"   y1="20"   x2="22.5" y2="22.5" stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="22.5" y1="5.5"  x2="20"   y2="8"    stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
      <line x1="8"    y1="20"   x2="5.5"  y2="22.5" stroke="#D84315" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="logo-text">Hannah <span>Solar</span></span>
  </div>
  <div class="divider"></div>
  <div class="page-title">Project Gantt</div>
  <div class="spacer"></div>
  <div id="status-pill" class="status-pill loading">
    <div class="dot"></div>
    <span id="status-text">Connectingâ€¦</span>
  </div>
</div>

<!-- â”€â”€â”€ TOOLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toolbar">
  <span class="tb-label">View</span>
  <div class="btn-group">
    <button class="btn active" id="btn-all" onclick="setView('all')">All Projects</button>
    <button class="btn" id="btn-project" onclick="setView('project')">Per Project</button>
  </div>

  <div class="tb-sep"></div>

  <span class="tb-label">Zoom</span>
  <div class="btn-group">
    <button class="btn" id="zoom-month"   onclick="setZoom('month')">Month</button>
    <button class="btn active" id="zoom-quarter" onclick="setZoom('quarter')">Quarter</button>
    <button class="btn" id="zoom-year"    onclick="setZoom('year')">Year</button>
  </div>

  <div class="tb-sep"></div>

  <select id="project-select" onchange="filterProject(this.value)">
    <option value="all">â€” All Projects â€”</option>
  </select>

  <div class="tb-sep"></div>

  <div class="btn-group">
    <button class="btn" onclick="collapseAll()" title="Collapse All">âŠŸ</button>
    <button class="btn" onclick="expandAll()" title="Expand All">âŠ</button>
  </div>

  <button class="btn" onclick="printGantt()" title="Print">ğŸ–¨</button>
  <button class="btn primary" onclick="refreshData()">â†» Refresh</button>

  <div id="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#2E7D32"></div>Complete</div>
    <div class="legend-item"><div class="legend-dot" style="background:#1565C0"></div>In Progress</div>
    <div class="legend-item"><div class="legend-dot" style="background:#C62828"></div>Delayed</div>
    <div class="legend-item"><div class="legend-dot" style="background:#9CA3AF"></div>Not Started</div>
    <div class="legend-item"><div class="legend-diamond"></div>Milestone</div>
  </div>
</div>

<!-- â”€â”€â”€ GANTT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="gantt-wrap">
  <div id="gantt_here"></div>
  <div id="overlay">
    <div class="spinner"></div>
    <div class="overlay-title">Loading Projectsâ€¦</div>
    <div class="overlay-sub" id="overlay-sub">Connecting to Zoho Creator</div>
  </div>
</div>

<!-- â”€â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="detail-modal" onclick="closeDetail(event)">
  <div id="detail-card">
    <div id="detail-header">
      <div class="detail-title" id="detail-title">Task Name</div>
      <button class="detail-close" onclick="closeDetailBtn()">âœ•</button>
    </div>
    <div id="detail-body"></div>
    <div id="detail-footer">
      <button class="btn" onclick="closeDetailBtn()">Close</button>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="toast" class="hidden"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURATION â€” Update these values
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CONFIG = {
  clientId:     '1000.BLOH3Q6D2RLURL3X7I8MBOLOSZKJ9A',
  clientSecret: '3448d7ff6a2f41fb5721b6afa63f918ab6e66edacc',
  refreshToken: '1000.20d461521b84917fa16da7d8498e06dc.e66f51e1fc859d0e808d73f8cd60d279',
  accountsUrl:  'https://accounts.zoho.com',
  apiDomain:    'https://www.zohoapis.com',
  ownerName:    'hannahsolar',
  appLinkName:  'hannah-solar-project-management',
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let accessToken  = null;
let tokenExpiry  = 0;
let allProjects  = [];
let allMilestones = [];
let allTasks     = [];
let currentView  = 'all';
let currentZoom  = 'quarter';
let currentFilter = 'all';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OAUTH â€” Token refresh
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function getAccessToken() {
  if (accessToken) return accessToken;

  const resp = await fetch('./token.json?nocache=' + Date.now());
  if (!resp.ok) throw new Error(`Could not load token.json (HTTP ${resp.status})`);
  const data = await resp.json();
  if (!data.access_token) throw new Error('No access_token found in token.json');

  accessToken = data.access_token;
  return accessToken;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CREATOR REST API â€” Fetch records
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchReport(reportLinkName) {
  const token = await getAccessToken();
  const url = `${CONFIG.apiDomain}/creator/v2.1/data/${CONFIG.ownerName}/${CONFIG.appLinkName}/report/${reportLinkName}?max_records=200`;

  const resp = await fetch(url, {
    headers: { 'Authorization': `Zoho-oauthtoken ${token}` }
  });

  if (!resp.ok) {
    const errText = await resp.text();
    throw new Error(`API error ${resp.status} on ${reportLinkName}: ${errText}`);
  }
  const data = await resp.json();
  return data.data || [];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CREATOR REST API â€” Update a record
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function updateRecord(reportLinkName, recordId, fields) {
  const token = await getAccessToken();
  const url = `${CONFIG.apiDomain}/creator/v2.1/data/${CONFIG.ownerName}/${CONFIG.appLinkName}/report/${reportLinkName}/${recordId}`;

  const resp = await fetch(url, {
    method: 'PATCH',
    headers: {
      'Authorization': `Zoho-oauthtoken ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ data: fields }),
  });

  if (!resp.ok) {
    const errText = await resp.text();
    throw new Error(`Update error ${resp.status}: ${errText}`);
  }
  return await resp.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATE HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseDate(str) {
  if (!str || str.trim() === '') return null;
  const creatorFormat = str.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{4})$/);
  if (creatorFormat) {
    const months = {Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
    const day   = parseInt(creatorFormat[1]);
    const month = months[creatorFormat[2]];
    const year  = parseInt(creatorFormat[3]);
    if (month !== undefined) return new Date(year, month, day);
  }
  const d = new Date(str);
  return isNaN(d) ? null : d;
}

function formatForCreator(date) {
  if (!date) return null;
  const d = new Date(date);
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = months[d.getMonth()];
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

function safeDate(str) {
  const d = parseDate(str);
  return d || new Date();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LOAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadData() {
  setStatus('loading', 'Loadingâ€¦');
  showOverlay('Loading Projectsâ€¦', 'Reading data from Zoho Creator');

  try {
    const resp = await fetch('./data.json?nocache=' + Date.now());
    if (!resp.ok) throw new Error(`Could not load data.json (HTTP ${resp.status}). Run the GitHub Action first.`);
    const data = await resp.json();

    allProjects   = data.projects   || [];
    allMilestones = data.milestones || [];
    allTasks      = data.tasks      || [];

    const updatedAt = data.updated_at ? new Date(data.updated_at).toLocaleTimeString() : 'unknown';

    populateProjectFilter();
    renderGantt();
    hideOverlay();
    setStatus('connected', `${allProjects.length} projects Â· synced ${updatedAt}`);
    showToast(`Loaded ${allProjects.length} projects, ${allMilestones.length} milestones, ${allTasks.length} tasks`, 'success');

  } catch (err) {
    console.error(err);
    showOverlayError(err.message);
    setStatus('error', 'Load failed');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECT FILTER DROPDOWN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function populateProjectFilter() {
  const sel = document.getElementById('project-select');
  while (sel.options.length > 1) sel.remove(1);
  allProjects.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.Project_Name;
    opt.textContent = p.Project_Name;
    sel.appendChild(opt);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILD GANTT DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildGanttData() {
  const tasks_data = [];
  const links_data = [];
  let id = 1;

  const filteredProjects = currentFilter === 'all'
    ? allProjects
    : allProjects.filter(p => p.Project_Name === currentFilter);

  filteredProjects.forEach(project => {
    const pStart = safeDate(project.Start_Date);
    const pEndRaw = project.Projected_End_Date || project.Original_End_Date;
    const pEnd = pEndRaw ? safeDate(pEndRaw) : new Date(safeDate(project.Start_Date).getTime() + 180*24*60*60*1000);
    const pId    = id++;

    tasks_data.push({
      id:        pId,
      text:      project.Project_Name,
      start_date: pStart,
      end_date:   pEnd,
      type:       'project',
      open:       true,
      readonly:   true,
      $source_id: project.ID,
      $type:      'project',
      $status:    project.Project_Status,
    });

    if (currentView === 'all') {
      const projMilestones = allMilestones.filter(m =>
        m.Project && (m.Project.display_value === project.Project_Name || m.Project === project.Project_Name)
      );

      projMilestones.forEach(m => {
        const mId = id++;
        const mDate = safeDate(m.Planned_End_Date || m.Planned_Start_Date);

        tasks_data.push({
          id:          mId,
          text:        m.Milestone_Name,
          start_date:  mDate,
          end_date:    new Date(mDate.getTime() + 86400000),
          type:        'milestone',
          parent:      pId,
          $source_id:  m.ID,
          $type:       'milestone',
          $status:     m.Status,
          $payment:    m.Payment_Triggered,
          $amount:     m.Payment_Amount,
        });
      });

    } else {
      const projMilestones = allMilestones.filter(m =>
        m.Project && (m.Project.ID === project.ID || m.Project.zc_display_value === project.Project_Name)
      );

      const phases = {};
      projMilestones.forEach(m => {
        const ph = m.Phase || 'General';
        if (!phases[ph]) phases[ph] = [];
        phases[ph].push(m);
      });

      Object.entries(phases).forEach(([phase, phaseMilestones]) => {
        const phaseId = id++;
        const phaseDates = phaseMilestones.map(m => safeDate(m.Planned_Start_Date)).filter(Boolean);
        const phaseEndDates = phaseMilestones.map(m => safeDate(m.Planned_End_Date)).filter(Boolean);
        const phaseStart = phaseDates.length   ? new Date(Math.min(...phaseDates))    : pStart;
        const phaseEnd   = phaseEndDates.length ? new Date(Math.max(...phaseEndDates)) : pEnd;

        tasks_data.push({
          id:         phaseId,
          text:       phase,
          start_date: phaseStart,
          end_date:   phaseEnd,
          type:       'project',
          parent:     pId,
          open:       true,
          readonly:   true,
          $type:      'phase',
        });

        phaseMilestones.forEach(m => {
          const mId    = id++;
          const mStart = safeDate(m.Planned_Start_Date);
          const mEnd   = safeDate(m.Planned_End_Date);

          tasks_data.push({
            id:         mId,
            text:       m.Milestone_Name,
            start_date: mStart,
            end_date:   mEnd,
            type:       gantt.config.types.task,
            parent:     phaseId,
            open:       true,
            $source_id: m.ID,
            $type:      'milestone',
            $status:    m.Status,
            $payment:   m.Payment_Triggered,
            $amount:    m.Payment_Amount,
          });

          const milestoneTasks = allTasks.filter(t =>
            t.Milestone && (t.Milestone.ID === m.ID || t.Milestone.zc_display_value === m.Milestone_Name)
          );

          milestoneTasks.forEach(t => {
            if (!t.Planned_Start_Date || !t.Planned_End_Date) return;
            const tStart = parseDate(t.Planned_Start_Date);
            const tEnd   = parseDate(t.Planned_End_Date);
            if (!tStart || !tEnd) return;

            const tId = id++;
            tasks_data.push({
              id:         tId,
              text:       t.Task_Name,
              start_date: tStart,
              end_date:   tEnd,
              type:       gantt.config.types.task,
              parent:     mId,
              $source_id: t.ID,
              $type:      'task',
              $status:    t.Status,
              $form:      'All_Tasks',
            });
          });
        });
      });
    }
  });

  return { data: tasks_data, links: links_data };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GANTT INIT & CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initGantt() {
  gantt.config.date_format   = '%Y-%m-%d';
  gantt.config.xml_date      = '%Y-%m-%d';
  gantt.config.scroll_on_click = false;
  gantt.config.show_progress = true;
  gantt.config.readonly      = false;
  gantt.config.drag_progress = false;
  gantt.config.drag_links    = false;
  gantt.config.drag_move     = false;
  gantt.config.drag_resize   = false;
  gantt.config.open_tree_initially = true;
  gantt.config.fit_tasks     = true;
  gantt.config.row_height    = 34;
  gantt.config.bar_height    = 20;
  gantt.config.min_column_width = 40;
  gantt.config.autosize      = false;
  gantt.config.scroll_size   = 10;
  gantt.config.layout = {
    css: 'gantt_container',
    rows: [
      {
        cols: [
          { view: 'grid',      scrollX: 'scrollHor', scrollY: 'scrollVer', id: 'grid' },
          { resizer: true, width: 1 },
          { view: 'timeline',  scrollX: 'scrollHor', scrollY: 'scrollVer', id: 'timeline' },
          { view: 'scrollbar', id: 'scrollVer' },
        ]
      },
      { view: 'scrollbar', id: 'scrollHor', height: 10 }
    ]
  };

  gantt.config.columns = [
    {
      name:  'text',
      label: 'Task / Milestone',
      width: 240,
      tree:  true,
      template: (task) => {
        const icon = task.$type === 'milestone' ? 'â—† ' :
                     task.$type === 'phase'     ? 'â–¸ ' :
                     task.$type === 'project'   ? '' : '  ';
        return icon + (task.text || '');
      }
    },
    {
      name:  'start_date',
      label: 'Start',
      width: 90,
      align: 'center',
      template: (task) => {
        if (!task.start_date) return 'â€”';
        return task.start_date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    },
    {
      name:  'end_date',
      label: 'End',
      width: 90,
      align: 'center',
      template: (task) => {
        if (!task.end_date || task.type === 'milestone') return 'â€”';
        return task.end_date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    },
    {
      name:  '$status',
      label: 'Status',
      width: 100,
      align: 'center',
      template: (task) => {
        if (!task.$status) return '';
        const colors = {
          'Complete':    '#2E7D32',
          'In Progress': '#1565C0',
          'Delayed':     '#C62828',
          'Not Started': '#6B7280',
          'Blocked':     '#C62828',
        };
        const c = colors[task.$status] || '#6B7280';
        return `<span style="color:${c};font-size:11px;font-weight:500;">${task.$status}</span>`;
      }
    },
  ];

  setZoom('quarter', false);

  gantt.templates.task_class = (start, end, task) => {
    const classes = [];
    if (task.type === 'project') classes.push('type-project');
    if (task.$status === 'Complete')    classes.push('status-complete');
    if (task.$status === 'In Progress') classes.push('status-in-progress');
    if (task.$status === 'Delayed')     classes.push('status-delayed');
    if (task.$status === 'Not Started') classes.push('status-not-started');
    if (task.$type === 'milestone')     classes.push('type-milestone-bar');
    return classes.join(' ');
  };

  gantt.templates.tooltip_text = (start, end, task) => {
    let html = `<strong style="color:var(--text)">${task.text}</strong><br/>`;
    if (task.$status) html += `<span style="color:var(--muted)">Status:</span> ${task.$status}<br/>`;
    if (task.start_date) html += `<span style="color:var(--muted)">Start:</span> ${task.start_date.toLocaleDateString()}<br/>`;
    if (task.end_date && task.type !== 'milestone') html += `<span style="color:var(--muted)">End:</span> ${task.end_date.toLocaleDateString()}<br/>`;
    if (task.$payment === 'Yes' && task.$amount) html += `<span style="color:var(--accent)">ğŸ’° Payment: $${Number(task.$amount).toLocaleString()}</span>`;
    return html;
  };

  gantt.templates.grid_row_class = (start, end, task) => {
    if (task.type === 'project' && task.$type !== 'phase') return 'gantt_project_row';
    return '';
  };

  if (typeof gantt.addMarker === 'function') {
    gantt.addMarker({
      start_date: new Date(),
      css: 'gantt_today',
      text: 'Today',
      title: 'Today'
    });
  }

  gantt.attachEvent('onTaskClick', (id, e) => {
    const task = gantt.getTask(id);
    openDetail(task);
    return true;
  });

  gantt.init('gantt_here');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER GANTT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGantt() {
  const { data, links } = buildGanttData();
  if (data.length === 0) {
    showOverlayError('No project data found. Add projects in Zoho Creator first.');
    return;
  }
  gantt.clearAll();
  gantt.parse({ data, links });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZOOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setZoom(level, rerender = true) {
  currentZoom = level;
  ['month','quarter','year'].forEach(z => {
    document.getElementById(`zoom-${z}`).classList.toggle('active', z === level);
  });

  if (level === 'month') {
    gantt.config.scales = [
      { unit: 'month', step: 1, format: '%F %Y' },
      { unit: 'week',  step: 1, format: 'Wk %W' },
    ];
    gantt.config.min_column_width = 80;
  } else if (level === 'quarter') {
    gantt.config.scales = [
      { unit: 'quarter', step: 1, format: (d) => {
          const q = Math.floor(d.getMonth() / 3) + 1;
          return `Q${q} ${d.getFullYear()}`;
        }
      },
      { unit: 'month', step: 1, format: '%M' },
    ];
    gantt.config.min_column_width = 60;
  } else {
    gantt.config.scales = [
      { unit: 'year',    step: 1, format: '%Y' },
      { unit: 'quarter', step: 1, format: (d) => `Q${Math.floor(d.getMonth()/3)+1}` },
    ];
    gantt.config.min_column_width = 80;
  }

  if (rerender && allProjects.length > 0) gantt.render();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setView(view) {
  currentView = view;
  document.getElementById('btn-all').classList.toggle('active', view === 'all');
  document.getElementById('btn-project').classList.toggle('active', view === 'project');
  if (allProjects.length > 0) renderGantt();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECT FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function filterProject(value) {
  currentFilter = value;
  if (allProjects.length > 0) renderGantt();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REFRESH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function refreshData() {
  accessToken = null;
  loadData();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setStatus(state, text) {
  const pill = document.getElementById('status-pill');
  const span = document.getElementById('status-text');
  pill.className = `status-pill ${state}`;
  span.textContent = text;
}

function showOverlay(title, sub) {
  const el = document.getElementById('overlay');
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="spinner"></div>
    <div class="overlay-title">${title}</div>
    <div class="overlay-sub">${sub}</div>
  `;
}

function showOverlayError(msg) {
  const el = document.getElementById('overlay');
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="overlay-title overlay-error">âš  Connection Error</div>
    <div class="overlay-sub">${msg}</div>
    <button class="btn primary" style="margin-top:8px" onclick="refreshData()">Retry</button>
  `;
}

function hideOverlay() {
  document.getElementById('overlay').classList.add('hidden');
}

let toastTimer = null;
function showToast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.className = `${type}`;
  el.textContent = msg;
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = 'hidden'; }, 3500);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLLAPSE / EXPAND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function collapseAll() {
  gantt.eachTask(task => { if (task.$has_child) gantt.close(task.id); });
}

function expandAll() {
  gantt.eachTask(task => { if (task.$has_child) gantt.open(task.id); });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function printGantt() { window.print(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openDetail(task) {
  if (task.type === 'project' && task.$type !== 'milestone') return;

  const statusColors = {
    'Complete':    '#2E7D32',
    'In Progress': '#1565C0',
    'Delayed':     '#C62828',
    'Not Started': '#6B7280',
    'Blocked':     '#C62828',
    'Prospect':    '#6B7280',
    'Awarded':     '#1565C0',
  };

  const typeLabel = task.$type === 'milestone' ? 'â—† Milestone' :
                    task.$type === 'task'       ? 'Task' :
                    task.$type === 'phase'      ? 'Phase' : 'Project';

  const startStr = task.start_date ? task.start_date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'â€”';
  const endStr   = task.end_date   ? task.end_date.toLocaleDateString('en-US',   { month: 'short', day: 'numeric', year: 'numeric' }) : 'â€”';

  let duration = 'â€”';
  if (task.start_date && task.end_date) {
    const days = Math.round((task.end_date - task.start_date) / (1000*60*60*24));
    duration = `${days} day${days !== 1 ? 's' : ''}`;
  }

  const statusColor = statusColors[task.$status] || '#6B7280';
  const statusHtml = task.$status
    ? `<span class="detail-status"><span class="dot" style="background:${statusColor}"></span>${task.$status}</span>`
    : 'â€”';

  const paymentHtml = task.$payment === 'Yes' && task.$amount
    ? `<span style="color:var(--accent);font-weight:600;">$${Number(task.$amount).toLocaleString()}</span>`
    : task.$payment === 'Yes' ? 'Yes' : 'â€”';

  document.getElementById('detail-title').textContent = task.text;
  document.getElementById('detail-body').innerHTML = `
    <div class="detail-field">
      <div class="detail-label">Type</div>
      <div class="detail-value">${typeLabel}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Status</div>
      <div class="detail-value">${statusHtml}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Start Date</div>
      <div class="detail-value">${startStr}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">End Date</div>
      <div class="detail-value">${endStr}</div>
    </div>
    <div class="detail-field">
      <div class="detail-label">Duration</div>
      <div class="detail-value">${duration}</div>
    </div>
    ${task.$payment !== undefined ? `
    <div class="detail-field">
      <div class="detail-label">Payment Trigger</div>
      <div class="detail-value">${paymentHtml}</div>
    </div>` : ''}
  `;

  document.getElementById('detail-modal').classList.add('open');
}

function closeDetail(e) {
  if (e.target === document.getElementById('detail-modal')) {
    document.getElementById('detail-modal').classList.remove('open');
  }
}

function closeDetailBtn() {
  document.getElementById('detail-modal').classList.remove('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD SCROLL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', (e) => {
  if (!allProjects.length) return;
  const scrollAmount = 120;
  const state = gantt.getScrollState();
  if (e.key === 'ArrowLeft')  { gantt.scrollTo(state.x - scrollAmount, state.y); e.preventDefault(); }
  if (e.key === 'ArrowRight') { gantt.scrollTo(state.x + scrollAmount, state.y); e.preventDefault(); }
  if (e.key === 'ArrowUp')    { gantt.scrollTo(state.x, state.y - scrollAmount); e.preventDefault(); }
  if (e.key === 'ArrowDown')  { gantt.scrollTo(state.x, state.y + scrollAmount); e.preventDefault(); }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('load', () => {
  if (typeof gantt === 'undefined') {
    showOverlayError('Gantt library failed to load. Please check your internet connection and refresh.');
    setStatus('error', 'Library failed');
    return;
  }
  initGantt();
  loadData();
});
</script>
</body>
</html>
